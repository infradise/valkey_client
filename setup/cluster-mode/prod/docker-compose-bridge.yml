# version: ""
#   NOTE: the attribute `version` is obsolete, it will be ignored, please remove it to avoid potential confusion.
services:
  # --- Master Nodes ---
  valkey-7001:
    image: valkey/valkey:latest
    container_name: valkey-7001
    command: >
      valkey-server --port 7001
      --cluster-enabled yes
      --cluster-config-file nodes-7001.conf
      --cluster-node-timeout 5000
      --cluster-announce-ip 127.0.0.1
      --cluster-announce-port 7001
      --cluster-announce-bus-port 17001
      --appendonly yes
    ports:
      - "7001:7001"
      - "17001:17001"
    # networks:
    #   - valkey-net

  valkey-7002:
    image: valkey/valkey:latest
    container_name: valkey-7002
    command: >
      valkey-server --port 7002
      --cluster-enabled yes
      --cluster-config-file nodes-7002.conf
      --cluster-node-timeout 5000
      --cluster-announce-ip 127.0.0.1
      --cluster-announce-port 7002
      --cluster-announce-bus-port 17002
      --appendonly yes
    ports:
      - "7002:7002"
      - "17002:17002"
    # networks:
    #   - valkey-net

  # --- Replica Nodes ---
  valkey-7003:
    image: valkey/valkey:latest
    container_name: valkey-7003
    command: >
      valkey-server --port 7003
      --cluster-enabled yes
      --cluster-config-file nodes-7003.conf
      --cluster-node-timeout 5000
      --cluster-announce-ip 127.0.0.1
      --cluster-announce-port 7003
      --cluster-announce-bus-port 17003
      --appendonly yes
    ports:
      - "7003:7003"
      - "17003:17003"
    # networks:
    #   - valkey-net

  valkey-7004:
    image: valkey/valkey:latest
    container_name: valkey-7004
    command: >
      valkey-server --port 7004
      --cluster-enabled yes
      --cluster-config-file nodes-7004.conf
      --cluster-node-timeout 5000
      --cluster-announce-ip 127.0.0.1
      --cluster-announce-port 7004
      --cluster-announce-bus-port 17004
      --appendonly yes
    ports:
      - "7004:7004"
      - "17004:17004"
    # networks:
    #   - valkey-net

  valkey-7005:
    image: valkey/valkey:latest
    container_name: valkey-7005
    command: >
      valkey-server --port 7005
      --cluster-enabled yes
      --cluster-config-file nodes-7005.conf
      --cluster-node-timeout 5000
      --cluster-announce-ip 127.0.0.1
      --cluster-announce-port 7005
      --cluster-announce-bus-port 17005
      --appendonly yes
    ports:
      - "7005:7005"
      - "17005:17005"
    # networks:
    #   - valkey-net

  valkey-7006:
    image: valkey/valkey:latest
    container_name: valkey-7006
    command: >
      valkey-server --port 7006
      --cluster-enabled yes
      --cluster-config-file nodes-7006.conf
      --cluster-node-timeout 5000
      --cluster-announce-ip 127.0.0.1
      --cluster-announce-port 7006
      --cluster-announce-bus-port 17006
      --appendonly yes
    ports:
      - "7006:7006"
      - "17006:17006" # Gossip bus port
    # networks:
    #   - valkey-net

  # --- Cluster Initializer ---
  cluster-init:
    image: valkey/valkey:latest
    container_name: valkey-cluster-init
    depends_on:
      - valkey-7001
      - valkey-7002
      - valkey-7003
      - valkey-7004
      - valkey-7005
      - valkey-7006
    entrypoint:
      - /bin/sh
      - -c
      - |
        echo "Waiting for all 6 cluster nodes to be ready..."

        # Wait for each node''s port to be open
        for port in 7001 7002 7003 7004 7005 7006; do
          host="valkey-$${port}"
          echo "Waiting for $${host}:$${port}..."

          # Keep trying to connect until success
          until valkey-cli -h $${host} -p $${port} ping > /dev/null 2>&1; do
            echo "Node $${host} not ready yet, retrying in 1s..."
            sleep 1
          done
          echo "$${host} is ready!"
        done

        echo "All nodes are up. Creating cluster..."
        sleep 2 # Final short delay for good measure

        # Now run the create command
        echo "yes" | valkey-cli --cluster create \
          valkey-7001:7001 \
          valkey-7002:7002 \
          valkey-7003:7003 \
          valkey-7004:7004 \
          valkey-7005:7005 \
          valkey-7006:7006 \
          --cluster-replicas 1

        echo "Cluster creation command sent. Waiting for cluster to be stable..."
        sleep 3 # Give nodes time to receive MEET commands

        # 3. Wait until the cluster is stable
        # Keep checking until 'cluster check' returns "[OK] All 16384 slots covered."
        until valkey-cli --cluster check valkey-7001:7001 2>&1 | grep -q '\[OK\] All 16384 slots covered.'; do
          echo "Cluster not stable yet, checking again in 2s..."
          sleep 2
        done

        echo "âœ… Cluster is stable and all slots are covered!"

###########################################
# networks:
#   valkey-net:
#     driver: bridge

# entrypoint: /bin/sh -c '
#   echo "Waiting for cluster nodes to be ready..."
#   sleep 10
#   echo "Yes" | valkey-cli --cluster create \
#     valkey-7001:7001 \
#     valkey-7002:7002 \
#     valkey-7003:7003 \
#     valkey-7004:7004 \
#     valkey-7005:7005 \
#     valkey-7006:7006 \
#     --cluster-replicas 1
#   '